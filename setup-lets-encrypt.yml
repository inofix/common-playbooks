#*  This playbook installs and prepares everything for acme-tiny for a certain
#* domain, that is declared by 'app__acme__tiny__domain'.
#*  Note: this playbook should be used either from the main install playbook
#* (which resolves its dependencies) or as a shorthand for an already set up
#* system, where the dependencies are already provided.
#*  Use '-a' to pass parameters to ansible (as '-e'). See ansible fetch for
#* details.
#*  The following arguments are mandatory:
#*   - 'app__acme__tiny__domain'
#*  Examples:
#* * A single run might look like this:
#*   `maestro.sh -b -H host -a 'app__acme__tiny__domain={{ certificate.main }}' \
#*              ansible-play setup-lets-encrypt
#* * If a certain hosts covers more than one certificate, it might be run
#* multiple times, e.g. by issuing some command like:
#*   `maestro.sh -b -H host ansible-play-loop setup-lets-encrypt \
#*              app__acme__tiny__domain "certificate.main:certificate.mail"`

# Do on all hosts related to acme (zwischenloesung.acme-tiny depends on
# zwischenloesung.acme-tiny-setup, no need to repeat)
- hosts: app.acme,!app.acme.tiny
  become: True
  roles:
    - { role: zwischenloesung.acme-tiny-setup }

# Do only on hosts with the acme-tiny application actually installed
- hosts: app.acme.tiny
  become: True
  roles:
    - { role: zwischenloesung.acme-tiny }
    - { role: zwischenloesung.acme-tiny-cron }

